name: Build FFmpeg Windows Static with fdk_aac + openh264

on:
  push:
  workflow_dispatch:

jobs:
  build-ffmpeg:
    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true

    - name: Update MSYS2
      shell: msys2 {0}
      run: |
        pacman -Syu --noconfirm

    - name: Install dependencies
      shell: msys2 {0}
      run: |
        pacman -S --noconfirm --needed \
          mingw-w64-x86_64-toolchain \
          base-devel \
          git \
          mingw-w64-x86_64-pkg-config \
          mingw-w64-x86_64-nasm \
          mingw-w64-x86_64-yasm \
          mingw-w64-x86_64-SDL2 \
          mingw-w64-x86_64-libx264 \
          mingw-w64-x86_64-x265 \
          mingw-w64-x86_64-lame \
          mingw-w64-x86_64-libvorbis \
          mingw-w64-x86_64-libvpx \
          mingw-w64-x86_64-libass \
          mingw-w64-x86_64-fontconfig \
          mingw-w64-x86_64-freetype \
          mingw-w64-x86_64-fribidi \
          mingw-w64-x86_64-libopusenc \
          mingw-w64-x86_64-vmaf \
          mingw-w64-x86_64-fdk-aac \
          mingw-w64-x86_64-openh264

    - name: Clone FFmpeg
      shell: msys2 {0}
      run: |
        git clone https://git.ffmpeg.org/ffmpeg.git ffmpeg
        cd ffmpeg
        git checkout n6.1.1

    - name: Configure FFmpeg
      shell: msys2 {0}
      run: |
        cd ffmpeg
        ./configure \
          --prefix="$HOME/ffmpeg-build" \
          --target-os=mingw32 \
          --arch=x86_64 \
          --enable-gpl \
          --enable-version3 \
          --enable-static \
          --disable-shared \
          --disable-debug \
          --disable-doc \
          --enable-libx264 \
          --enable-libx265 \
          --enable-libmp3lame \
          --enable-libvorbis \
          --enable-libvpx \
          --enable-libopus \
          --enable-libass \
          --enable-fontconfig \
          --enable-libfreetype \
          --enable-libfribidi \
          --enable-libvmaf \
          --enable-libfdk_aac \
          --enable-libopenh264 \
          --enable-nonfree

    - name: Build FFmpeg
      shell: msys2 {0}
      run: |
        cd ffmpeg
        make -j$(nproc)
        make install

    - name: Package Static Build
      shell: bash
      run: |
        7z a ffmpeg-win64-static.zip $HOME/ffmpeg-build/*

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-win64-static
        path: ffmpeg-win64-static.zip
