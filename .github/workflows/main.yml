name: Build 100% Static FFmpeg (Windows)

on:
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  build-static-ffmpeg:
    runs-on: windows-latest

    defaults:
      run:
        shell: msys2 {0}

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Setup MSYS2 toolchain
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true

    - name: Install build essentials
      run: |
        pacman -Syu --noconfirm
        pacman -S --noconfirm --needed \
          base-devel git mingw-w64-x86_64-toolchain \
          mingw-w64-x86_64-pkg-config mingw-w64-x86_64-nasm \
          mingw-w64-x86_64-yasm mingw-w64-x86_64-cmake

    - name: Build dependencies (static)
      run: |
        mkdir -p /mingw64/static
        cd /tmp

        # x264
        git clone --depth 1 https://code.videolan.org/videolan/x264.git
        cd x264
        ./configure --host=x86_64-w64-mingw32 --enable-static --disable-cli --prefix=/mingw64/static
        make -j$(nproc) && make install
        cd ..

        # x265
        curl -LO https://bitbucket.org/multicoreware/x265_git/downloads/x265_3.5.tar.gz
        tar -xzf x265_3.5.tar.gz
        cd x265_3.5/source
        mkdir -p ../build
        cd ../build
        cmake -G "MSYS Makefiles" ../source -DENABLE_SHARED=off -DENABLE_CLI=off -DCMAKE_INSTALL_PREFIX=/mingw64/static -DCMAKE_POLICY_VERSION_MINIMUM=3.5
        make -j$(nproc)
        make install

        # fdk-aac
        git clone --depth 1 https://github.com/mstorsjo/fdk-aac.git
        cd fdk-aac
        autoreconf -fiv
        ./configure --host=x86_64-w64-mingw32 --enable-static --disable-shared --prefix=/mingw64/static
        make -j$(nproc) && make install
        cd ..

        # libvpx
        git clone --depth 1 https://github.com/webmproject/libvpx.git
        cd libvpx
        ./configure --target=x86_64-win64-gcc --disable-examples --disable-tools --disable-shared --prefix=/mingw64/static
        make -j$(nproc) && make install
        cd ..

        # lame
        git clone --depth 1 https://github.com/lame-project/lame.git
        cd lame
        ./configure --host=x86_64-w64-mingw32 --enable-static --disable-shared --prefix=/mingw64/static
        make -j$(nproc) && make install
        cd ..

        # opus
        git clone --depth 1 https://github.com/xiph/opus.git
        cd opus
        ./configure --host=x86_64-w64-mingw32 --enable-static --disable-shared --prefix=/mingw64/static
        make -j$(nproc) && make install
        cd ..

        # openh264
        git clone --depth 1 https://github.com/cisco/openh264.git
        cd openh264
        make -j$(nproc) PREFIX=/mingw64/static ARCH=x86_64 OS=mingw64
        cp codec/encoder/openh264/* /mingw64/static/lib
        cp -r include /mingw64/static
        cd ..

        # SDL2
        git clone --depth 1 https://github.com/libsdl-org/SDL.git SDL2
        cd SDL2
        mkdir build && cd build
        cmake -DCMAKE_INSTALL_PREFIX=/mingw64/static -DSDL_STATIC=ON -DSDL_SHARED=OFF ..
        make -j$(nproc) && make install
        cd /tmp

        # fontconfig/freetype/fribidi
        pacman -S --noconfirm --needed \
          mingw-w64-x86_64-fontconfig \
          mingw-w64-x86_64-freetype \
          mingw-w64-x86_64-fribidi

        # vmaf
        pacman -S --noconfirm --needed mingw-w64-x86_64-vmaf

    - name: Build FFmpeg (static)
      run: |
        cd ffmpeg
        ./configure \
          --prefix=/mingw64/ffmpeg-static \
          --pkg-config-flags="--static" \
          --extra-cflags="-I/mingw64/static/include" \
          --extra-ldflags="-L/mingw64/static/lib" \
          --extra-libs="-lpthread -lm" \
          --enable-gpl --enable-version3 --enable-nonfree \
          --enable-static --disable-shared --disable-debug --disable-doc \
          --enable-libx264 --enable-libx265 --enable-libfdk_aac \
          --enable-libmp3lame --enable-libopus --enable-libvpx \
          --enable-libass --enable-libfreetype --enable-fontconfig \
          --enable-libfribidi --enable-libvmaf --enable-libopenh264 \
          --enable-sdl2
        make -j$(nproc)
        make install

    - name: Package final binary
      run: |
        cd /mingw64/ffmpeg-static/bin
        zip -j ffmpeg-win64-static.zip ffmpeg.exe ffprobe.exe

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-win64-static
        path: /mingw64/ffmpeg-win64-static.zip
